{% extends "base.html" %}

{% block title %}Trade {{ trade.id }} - Forex Journal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Trade Details -->
        <div class="col-lg-8">
            <!-- Trade Header Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>Trade #{{ trade.id }} - {{ trade.symbol }}
                        </h4>
                        <small class="text-muted">Created {{ trade.created_at.strftime('%Y-%m-%d at %H:%M') }}</small>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-{{ 'warning' if trade.status == 'open' else 'secondary' }} fs-6">
                            {{ trade.status|title }}
                        </span>
                        <span class="badge bg-{{ 'success' if trade.direction == 'BUY' else 'danger' }} fs-6">
                            {{ trade.direction }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Basic Trade Information -->
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Symbol:</strong>
                                </div>
                                <div class="col-6">
                                    {{ trade.symbol }}
                                    {% if trade.timeframe %}
                                    <span class="badge bg-info ms-1">{{ trade.timeframe }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Direction:</strong>
                                </div>
                                <div class="col-6">
                                    <span class="badge bg-{{ 'success' if trade.direction == 'BUY' else 'danger' }}">
                                        {{ trade.direction }}
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Entry Price:</strong>
                                </div>
                                <div class="col-6">
                                    {{ "%.5f"|format(trade.entry_price) }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Exit Price:</strong>
                                </div>
                                <div class="col-6">
                                    {% if trade.exit_price %}
                                        {{ "%.5f"|format(trade.exit_price) }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Position Size:</strong>
                                </div>
                                <div class="col-6">
                                    {{ "%.2f"|format(trade.size) }} lots
                                </div>
                            </div>
                        </div>

                        <!-- Performance & Timing -->
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>P&L:</strong>
                                </div>
                                <div class="col-6 {{ 'profit-positive' if trade.pnl and trade.pnl > 0 else 'profit-negative' if trade.pnl and trade.pnl < 0 else '' }}">
                                    {% if trade.pnl %}
                                        ${{ "%.2f"|format(trade.pnl) }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>P&L %:</strong>
                                </div>
                                <div class="col-6 {{ 'profit-positive' if trade.pnl_percent and trade.pnl_percent > 0 else 'profit-negative' if trade.pnl_percent and trade.pnl_percent < 0 else '' }}">
                                    {% if trade.pnl_percent %}
                                        {{ "%.2f"|format(trade.pnl_percent) }}%
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Strategy:</strong>
                                </div>
                                <div class="col-6">
                                    {{ trade.strategy or '-' }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Entry Time:</strong>
                                </div>
                                <div class="col-6">
                                    {{ trade.entry_time.strftime('%Y-%m-%d %H:%M') }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Exit Time:</strong>
                                </div>
                                <div class="col-6">
                                    {% if trade.exit_time %}
                                        {{ trade.exit_time.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Psychology & Duration -->
                    <div class="row mt-4 border-top pt-3">
                        <div class="col-md-4 text-center">
                            <h6>Emotional State</h6>
                            <div class="fs-4 mb-2">
                                {% if trade.emotions %}
                                    {% if trade.emotions == 'confident' %}
                                        üòä
                                    {% elif trade.emotions == 'neutral' %}
                                        üòê
                                    {% elif trade.emotions == 'anxious' %}
                                        üò∞
                                    {% elif trade.emotions == 'greedy' %}
                                        ü§¢
                                    {% elif trade.emotions == 'fearful' %}
                                        üò®
                                    {% elif trade.emotions == 'disciplined' %}
                                        üéØ
                                    {% elif trade.emotions == 'impulsive' %}
                                        ‚ö°
                                    {% else %}
                                        {{ trade.emotions }}
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {% if trade.emotions %}
                                    {{ trade.emotions|title }}
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-center">
                            <h6>Self Rating</h6>
                            <div class="fs-4 mb-2">
                                {% if trade.rating %}
                                    {% for i in range(trade.rating) %}‚≠ê{% endfor %}
                                    {% for i in range(5 - trade.rating) %}‚òÜ{% endfor %}
                                {% else %}
                                    <span class="text-muted">Not rated</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {% if trade.rating %}
                                    {{ trade.rating }}/5
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-center">
                            <h6>Trade Duration</h6>
                            <div class="fs-4 mb-2">
                                {% if trade.exit_time %}
                                    {% set duration = trade.exit_time - trade.entry_time %}
                                    {% if duration.days > 0 %}
                                        {{ duration.days }}d
                                    {% endif %}
                                    {{ (duration.seconds // 3600) }}h
                                    {{ ((duration.seconds % 3600) // 60) }}m
                                {% else %}
                                    <span class="text-muted">Ongoing</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {% if trade.exit_time %}
                                    {{ trade.entry_time.strftime('%m/%d') }} - {{ trade.exit_time.strftime('%m/%d') }}
                                {% else %}
                                    Since {{ trade.entry_time.strftime('%m/%d') }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes & Analysis Section -->
            <div class="row">
                <!-- Trade Notes -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-sticky-note me-2"></i>Trade Notes & Analysis
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if trade.notes %}
                                <div class="trade-notes">
                                    {{ trade.notes|replace('\n', '<br>')|safe }}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-sticky-note fa-2x mb-2"></i>
                                    <p>No notes provided for this trade.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Mistakes & Learnings -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Mistakes & Learnings
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if trade.mistakes %}
                                <div class="trade-mistakes">
                                    {{ trade.mistakes|replace('\n', '<br>')|safe }}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-lightbulb fa-2x mb-2"></i>
                                    <p>No mistakes recorded for this trade.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 col-6 mb-3">
                            <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}" class="btn btn-warning w-100">
                                <i class="fas fa-edit me-1"></i>Edit
                            </a>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <a href="{{ url_for('trades.new_trade') }}" class="btn btn-primary w-100">
                                <i class="fas fa-plus me-1"></i>New Trade
                            </a>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <a href="{{ url_for('trades.export_trades') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-download me-1"></i>Export
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screenshots Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-camera me-2"></i>Chart Screenshots
                    </h6>
                    <span class="badge bg-primary">{{ trade.images.count() }}</span>
                </div>
                <div class="card-body">
                    {% if trade.images.count() > 0 %}
                    <div class="row g-3">
                        {% for image in trade.images %}
                        <div class="col-12">
                            <div class="card screenshot-card">
                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}" 
                                     class="card-img-top screenshot-image" 
                                     alt="Trade screenshot"
                                     data-bs-toggle="modal" 
                                     data-bs-target="#imageModal"
                                     onclick="setModalImage('{{ url_for('static', filename='uploads/' + image.filename) }}')">
                                <div class="card-body text-center py-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ image.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </small>
                                    {% if image.image_type %}
                                    <br>
                                    <small class="badge bg-secondary">{{ image.image_type }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No Screenshots</h6>
                        <p class="text-muted mb-3">No chart screenshots uploaded for this trade</p>
                        <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-plus me-1"></i>Add Screenshots
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Trade Summary Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Trade Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold {{ 'text-success' if trade.pnl and trade.pnl > 0 else 'text-danger' if trade.pnl and trade.pnl < 0 else 'text-muted' }}">
                                    {% if trade.pnl %}
                                        ${{ "%.2f"|format(trade.pnl) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                <small class="text-muted">Net P&L</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold {{ 'text-success' if trade.pnl_percent and trade.pnl_percent > 0 else 'text-danger' if trade.pnl_percent and trade.pnl_percent < 0 else 'text-muted' }}">
                                    {% if trade.pnl_percent %}
                                        {{ "%.2f"|format(trade.pnl_percent) }}%
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                <small class="text-muted">Return %</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold text-info">
                                    {{ "%.5f"|format(trade.entry_price) }}
                                </div>
                                <small class="text-muted">Entry Price</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold {{ 'text-success' if trade.exit_price else 'text-warning' }}">
                                    {% if trade.exit_price %}
                                        {{ "%.5f"|format(trade.exit_price) }}
                                    {% else %}
                                        Open
                                    {% endif %}
                                </div>
                                <small class="text-muted">Exit Price</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Metrics -->
                    {% if trade.exit_price %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-center mb-3">Risk Metrics</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">Price Movement</small>
                                <div class="fw-bold">
                                    {% if trade.direction == 'BUY' %}
                                        {{ "%.5f"|format(trade.exit_price - trade.entry_price) }}
                                    {% else %}
                                        {{ "%.5f"|format(trade.entry_price - trade.exit_price) }}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Movement %</small>
                                <div class="fw-bold">
                                    {% if trade.direction == 'BUY' %}
                                        {{ "%.2f"|format(((trade.exit_price - trade.entry_price) / trade.entry_price * 100)) }}%
                                    {% else %}
                                        {{ "%.2f"|format(((trade.entry_price - trade.exit_price) / trade.entry_price * 100)) }}%
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('trades.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to All Trades
                </a>
                <div class="btn-group">
                    {% if trade.id > 1 %}
                    <a href="{{ url_for('trades.view_trade', trade_id=trade.id-1) }}" class="btn btn-outline-primary">
                        <i class="fas fa-chevron-left me-2"></i>Previous Trade
                    </a>
                    {% endif %}
                    <a href="{{ url_for('trades.view_trade', trade_id=trade.id+1) }}" class="btn btn-outline-primary">
                        Next Trade<i class="fas fa-chevron-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chart Screenshot - {{ trade.symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded" alt="Enlarged screenshot" style="max-height: 70vh;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="downloadImage" href="#" class="btn btn-primary" download>
                    <i class="fas fa-download me-2"></i>Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this trade?</p>
                <div class="alert alert-warning">
                    <strong>Trade Details:</strong><br>
                    #{{ trade.id }} - {{ trade.symbol }} {{ trade.direction }}<br>
                    Entry: {{ "%.5f"|format(trade.entry_price) }} on {{ trade.entry_time.strftime('%Y-%m-%d') }}
                </div>
                <p class="text-danger mb-0">
                    <strong>Warning:</strong> This action cannot be undone. All trade data and associated screenshots will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('trades.delete_trade', trade_id=trade.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Trade
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.screenshot-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    border: 1px solid #444;
    cursor: pointer;
}

.screenshot-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.screenshot-image {
    height: 200px;
    object-fit: cover;
    transition: opacity 0.2s ease-in-out;
}

.screenshot-image:hover {
    opacity: 0.9;
}

.trade-notes, .trade-mistakes {
    line-height: 1.6;
    max-height: 200px;
    overflow-y: auto;
}

.summary-item {
    padding: 10px 0;
}

.profit-positive {
    color: var(--bs-success) !important;
    font-weight: 600;
}

.profit-negative {
    color: var(--bs-danger) !important;
    font-weight: 600;
}

.card-header {
    background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
    border-bottom: 1px solid #444;
}

/* Custom scrollbar for notes */
.trade-notes::-webkit-scrollbar,
.trade-mistakes::-webkit-scrollbar {
    width: 6px;
}

.trade-notes::-webkit-scrollbar-track,
.trade-mistakes::-webkit-scrollbar-track {
    background: #2d2d2d;
    border-radius: 3px;
}

.trade-notes::-webkit-scrollbar-thumb,
.trade-mistakes::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
}

.trade-notes::-webkit-scrollbar-thumb:hover,
.trade-mistakes::-webkit-scrollbar-thumb:hover {
    background: #777;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .screenshot-image {
        height: 150px;
    }
    
    .btn-group .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
function setModalImage(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('downloadImage').href = imageSrc;
}

// Keyboard navigation for trade viewing
document.addEventListener('keydown', function(event) {
    // Only trigger if we're not in an input field
    if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
        if (event.key === 'ArrowLeft' && {{ trade.id > 1 }}) {
            window.location.href = "{{ url_for('trades.view_trade', trade_id=trade.id-1) }}";
        } else if (event.key === 'ArrowRight') {
            window.location.href = "{{ url_for('trades.view_trade', trade_id=trade.id+1) }}";
        } else if (event.key === 'Escape') {
            const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
            if (modal) {
                modal.hide();
            }
        }
    }
});

// Add loading state for images
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.screenshot-image');
    images.forEach(img => {
        img.addEventListener('load', function() {
            this.style.opacity = '1';
        });
        // Set initial opacity for fade-in effect
        img.style.opacity = '0';
        img.style.transition = 'opacity 0.3s ease-in-out';
    });
});
</script>
{% endblock %}
