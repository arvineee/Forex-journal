{% extends "base.html" %}

{% block title %}Trade {{ trade.id }} - Forex Journal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Trade Details -->
        <div class="col-lg-8">
            <!-- Trade Header Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="card-title mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>Trade #{{ trade.id }} - {{ trade.symbol }}
                        </h4>
                        <small class="text-muted">Created {{ trade.created_at.strftime('%Y-%m-%d at %H:%M') }}</small>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-{{ 'warning' if trade.status == 'open' else 'secondary' }} fs-6">
                            {{ trade.status|title }}
                        </span>
                        <span class="badge bg-{{ 'success' if trade.direction == 'BUY' else 'danger' }} fs-6">
                            {{ trade.direction }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Basic Trade Information -->
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Symbol:</strong>
                                </div>
                                <div class="col-6">
                                    {{ trade.symbol }}
                                    {% if trade.timeframe %}
                                    <span class="badge bg-info ms-1">{{ trade.timeframe }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Direction:</strong>
                                </div>
                                <div class="col-6">
                                    <span class="badge bg-{{ 'success' if trade.direction == 'BUY' else 'danger' }}">
                                        {{ trade.direction }}
                                    </span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Entry Price:</strong>
                                </div>
                                <div class="col-6">
                                    {{ "%.5f"|format(trade.entry_price) }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Exit Price:</strong>
                                </div>
                                <div class="col-6">
                                    {% if trade.exit_price %}
                                        {{ "%.5f"|format(trade.exit_price) }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Position Size:</strong>
                                </div>
                                <div class="col-6">
                                    {{ "%.2f"|format(trade.size) }} lots
                                </div>
                            </div>
                        </div>

                        <!-- Performance & Timing -->
                        <div class="col-md-6">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>P&L:</strong>
                                </div>
                                <div class="col-6 {{ 'profit-positive' if trade.pnl and trade.pnl > 0 else 'profit-negative' if trade.pnl and trade.pnl < 0 else '' }}">
                                    {% if trade.pnl %}
                                        ${{ "%.2f"|format(trade.pnl) }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>P&L %:</strong>
                                </div>
                                <div class="col-6 {{ 'profit-positive' if trade.pnl_percent and trade.pnl_percent > 0 else 'profit-negative' if trade.pnl_percent and trade.pnl_percent < 0 else '' }}">
                                    {% if trade.pnl_percent %}
                                        {{ "%.2f"|format(trade.pnl_percent) }}%
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Strategy:</strong>
                                </div>
                                <div class="col-6">
                                    {{ trade.strategy or '-' }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Entry Time:</strong>
                                </div>
                                <div class="col-6">
                                    {{ trade.entry_time.strftime('%Y-%m-%d %H:%M') }}
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Exit Time:</strong>
                                </div>
                                <div class="col-6">
                                    {% if trade.exit_time %}
                                        {{ trade.exit_time.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Psychology & Duration -->
                    <div class="row mt-4 border-top pt-3">
                        <div class="col-md-4 text-center">
                            <h6>Emotional State</h6>
                            <div class="fs-4 mb-2">
                                {% if trade.emotions %}
                                    {% if trade.emotions == 'confident' %}
                                        üòä
                                    {% elif trade.emotions == 'neutral' %}
                                        üòê
                                    {% elif trade.emotions == 'anxious' %}
                                        üò∞
                                    {% elif trade.emotions == 'greedy' %}
                                        ü§¢
                                    {% elif trade.emotions == 'fearful' %}
                                        üò®
                                    {% elif trade.emotions == 'disciplined' %}
                                        üéØ
                                    {% elif trade.emotions == 'impulsive' %}
                                        ‚ö°
                                    {% else %}
                                        {{ trade.emotions }}
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {% if trade.emotions %}
                                    {{ trade.emotions|title }}
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-center">
                            <h6>Self Rating</h6>
                            <div class="fs-4 mb-2">
                                {% if trade.rating %}
                                    {% for i in range(trade.rating) %}‚≠ê{% endfor %}
                                    {% for i in range(5 - trade.rating) %}‚òÜ{% endfor %}
                                {% else %}
                                    <span class="text-muted">Not rated</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {% if trade.rating %}
                                    {{ trade.rating }}/5
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-center">
                            <h6>Trade Duration</h6>
                            <div class="fs-4 mb-2">
                                {% if trade.exit_time %}
                                    {% set duration = trade.exit_time - trade.entry_time %}
                                    {% if duration.days > 0 %}
                                        {{ duration.days }}d
                                    {% endif %}
                                    {{ (duration.seconds // 3600) }}h
                                    {{ ((duration.seconds % 3600) // 60) }}m
                                {% else %}
                                    <span class="text-muted">Ongoing</span>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                {% if trade.exit_time %}
                                    {{ trade.entry_time.strftime('%m/%d') }} - {{ trade.exit_time.strftime('%m/%d') }}
                                {% else %}
                                    Since {{ trade.entry_time.strftime('%m/%d') }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes & Analysis Section -->
            <div class="row">
                <!-- Trade Notes -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-sticky-note me-2"></i>Trade Notes & Analysis
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if trade.notes %}
                                <div class="trade-notes">
                                    {{ trade.notes|replace('\n', '<br>')|safe }}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-sticky-note fa-2x mb-2"></i>
                                    <p>No notes provided for this trade.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Mistakes & Learnings -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-lightbulb me-2"></i>Mistakes & Learnings
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if trade.mistakes %}
                                <div class="trade-mistakes">
                                    {{ trade.mistakes|replace('\n', '<br>')|safe }}
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-lightbulb fa-2x mb-2"></i>
                                    <p>No mistakes recorded for this trade.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 col-6 mb-3">
                            <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}" class="btn btn-warning w-100">
                                <i class="fas fa-edit me-1"></i>Edit
                            </a>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <a href="{{ url_for('trades.new_trade') }}" class="btn btn-primary w-100">
                                <i class="fas fa-plus me-1"></i>New Trade
                            </a>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <a href="{{ url_for('trades.export_trades') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-download me-1"></i>Export
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screenshots Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-camera me-2"></i>Chart Screenshots
                    </h6>
                    <span class="badge bg-primary">{{ trade.images.count() }}</span>
                </div>
                <div class="card-body">
                    {% if trade.images.count() > 0 %}
                    <div class="row g-3">
                        {% for image in trade.images %}
                        <div class="col-12">
                            <div class="card screenshot-card">
                                <img src="{{ url_for('static', filename='uploads/' + image.filename) }}" 
                                     class="card-img-top screenshot-image" 
                                     alt="Trade screenshot"
                                     data-bs-toggle="modal" 
                                     data-bs-target="#imageModal"
                                     onclick="setModalImage('{{ url_for('static', filename='uploads/' + image.filename) }}')">
                                <div class="card-body text-center py-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {{ image.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </small>
                                    {% if image.image_type %}
                                    <br>
                                    <small class="badge bg-secondary">{{ image.image_type }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No Screenshots</h6>
                        <p class="text-muted mb-3">No chart screenshots uploaded for this trade</p>
                        <a href="{{ url_for('trades.edit_trade', trade_id=trade.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-plus me-1"></i>Add Screenshots
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Trade Summary Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Trade Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold {{ 'text-success' if trade.pnl and trade.pnl > 0 else 'text-danger' if trade.pnl and trade.pnl < 0 else 'text-muted' }}">
                                    {% if trade.pnl %}
                                        ${{ "%.2f"|format(trade.pnl) }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                <small class="text-muted">Net P&L</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold {{ 'text-success' if trade.pnl_percent and trade.pnl_percent > 0 else 'text-danger' if trade.pnl_percent and trade.pnl_percent < 0 else 'text-muted' }}">
                                    {% if trade.pnl_percent %}
                                        {{ "%.2f"|format(trade.pnl_percent) }}%
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                <small class="text-muted">Return %</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold text-info">
                                    {{ "%.5f"|format(trade.entry_price) }}
                                </div>
                                <small class="text-muted">Entry Price</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="summary-item">
                                <div class="fs-5 fw-bold {{ 'text-success' if trade.exit_price else 'text-warning' }}">
                                    {% if trade.exit_price %}
                                        {{ "%.5f"|format(trade.exit_price) }}
                                    {% else %}
                                        Open
                                    {% endif %}
                                </div>
                                <small class="text-muted">Exit Price</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Risk Metrics -->
                    {% if trade.exit_price %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-center mb-3">Risk Metrics</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <small class="text-muted">Price Movement</small>
                                <div class="fw-bold">
                                    {% if trade.direction == 'BUY' %}
                                        {{ "%.5f"|format(trade.exit_price - trade.entry_price) }}
                                    {% else %}
                                        {{ "%.5f"|format(trade.entry_price - trade.exit_price) }}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Movement %</small>
                                <div class="fw-bold">
                                    {% if trade.direction == 'BUY' %}
                                        {{ "%.2f"|format(((trade.exit_price - trade.entry_price) / trade.entry_price * 100)) }}%
                                    {% else %}
                                        {{ "%.2f"|format(((trade.entry_price - trade.exit_price) / trade.entry_price * 100)) }}%
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('trades.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to All Trades
                </a>
                <div class="btn-group">
                    {% if trade.id > 1 %}
                    <a href="{{ url_for('trades.view_trade', trade_id=trade.id-1) }}" class="btn btn-outline-primary">
                        <i class="fas fa-chevron-left me-2"></i>Previous Trade
                    </a>
                    {% endif %}
                    <a href="{{ url_for('trades.view_trade', trade_id=trade.id+1) }}" class="btn btn-outline-primary">
                        Next Trade<i class="fas fa-chevron-right ms-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chart Screenshot - {{ trade.symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded" alt="Enlarged screenshot" style="max-height: 70vh;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a id="downloadImage" href="#" class="btn btn-primary" download>
                    <i class="fas fa-download me-2"></i>Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this trade?</p>
                <div class="alert alert-warning">
                    <strong>Trade Details:</strong><br>
                    #{{ trade.id }} - {{ trade.symbol }} {{ trade.direction }}<br>
                    Entry: {{ "%.5f"|format(trade.entry_price) }} on {{ trade.entry_time.strftime('%Y-%m-%d') }}
                </div>
                <p class="text-danger mb-0">
                    <strong>Warning:</strong> This action cannot be undone. All trade data and associated screenshots will be permanently deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('trades.delete_trade', trade_id=trade.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete Trade
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>



<!-- Annotation Modal -->
<div class="modal fade" id="annotationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chart Annotation Tool - {{ trade.symbol }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="container-fluid h-100">
                    <div class="row h-100">
                        <!-- Tools Panel -->
                        <div class="col-md-2 bg-dark border-end">
                            <div class="d-flex flex-column p-3">
                                <!-- Drawing Tools -->
                                <h6 class="text-light mb-3">Drawing Tools</h6>

                                <div class="btn-group-vertical w-100 mb-3" role="group">
                                    <button type="button" class="btn btn-outline-primary active" data-tool="select">
                                        <i class="fas fa-mouse-pointer"></i> Select
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-tool="line">
                                        <i class="fas fa-minus"></i> Line
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-tool="horizontal-line">
                                        <i class="fas fa-arrows-alt-h"></i> Horizontal
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-tool="vertical-line">
                                        <i class="fas fa-arrows-alt-v"></i> Vertical
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-tool="ray">
                                        <i class="fas fa-long-arrow-alt-right"></i> Ray
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-tool="arrow">
                                        <i class="fas fa-arrow-right"></i> Arrow
                                    </button>
                                </div>

                                <div class="btn-group-vertical w-100 mb-3" role="group">
                                    <button type="button" class="btn btn-outline-primary" data-tool="rectangle">
                                        <i class="fas fa-square"></i> Rectangle
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-tool="circle">
                                        <i class="fas fa-circle"></i> Circle
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" data-tool="triangle">
                                        <i class="fas fa-play"></i> Triangle
                                    </button>
                                </div>

                                <!-- Fibonacci Tools -->
                                <h6 class="text-light mb-3 mt-3">Fibonacci</h6>
                                <div class="btn-group-vertical w-100 mb-3" role="group">
                                    <button type="button" class="btn btn-outline-warning" data-tool="fibonacci-retracement">
                                        <i class="fas fa-ruler-combined"></i> Retracement
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" data-tool="fibonacci-extension">
                                        <i class="fas fa-expand-arrows-alt"></i> Extension
                                    </button>
                                </div>

                                <!-- Text & Freehand -->
                                <div class="btn-group-vertical w-100 mb-3" role="group">
                                    <button type="button" class="btn btn-outline-info" data-tool="text">
                                        <i class="fas fa-font"></i> Text
                                    </button>
                                    <button type="button" class="btn btn-outline-info" data-tool="freehand">
                                        <i class="fas fa-pencil-alt"></i> Freehand
                                    </button>
                                </div>

                                <!-- Delete Tools -->
                                <div class="btn-group-vertical w-100 mb-3" role="group">
                                    <button type="button" class="btn btn-outline-danger" id="deleteSelected">
                                        <i class="fas fa-trash"></i> Delete Selected
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" id="clearAll">
                                        <i class="fas fa-broom"></i> Clear All
                                    </button>
                                </div>

                                <!-- Properties -->
                                <h6 class="text-light mb-3 mt-3">Properties</h6>
                                <div class="mb-3">
                                    <label class="form-label text-light small">Color</label>
                                    <input type="color" class="form-control form-control-color" id="drawingColor" value="#ff0000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light small">Line Width</label>
                                    <input type="range" class="form-range" id="lineWidth" min="1" max="10" value="2">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light small">Font Size</label>
                                    <input type="range" class="form-range" id="fontSize" min="12" max="36" value="16">
                                </div>
                            </div>
                        </div>

                        <!-- Canvas Area -->
                        <div class="col-md-10">
                            <div class="position-relative h-100">
                                <canvas id="annotationCanvas" width="1200" height="800"
                                        style="border: 1px solid #444; background: #1a1a1a; cursor: crosshair;">
                                </canvas>
                                <div id="canvasOverlay" class="position-absolute top-0 start-0 w-100 h-100"
                                     style="pointer-events: none; z-index: 10;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <button type="button" class="btn btn-outline-secondary" id="undoBtn" disabled>
                        <i class="fas fa-undo"></i> Undo
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="redoBtn" disabled>
                        <i class="fas fa-redo"></i> Redo
                    </button>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveAnnotation">
                    <i class="fas fa-save"></i> Save Annotations
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.screenshot-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    border: 1px solid #444;
    cursor: pointer;
}

.screenshot-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.screenshot-image {
    height: 200px;
    object-fit: cover;
    transition: opacity 0.2s ease-in-out;
}

.screenshot-image:hover {
    opacity: 0.9;
}

.trade-notes, .trade-mistakes {
    line-height: 1.6;
    max-height: 200px;
    overflow-y: auto;
}

.summary-item {
    padding: 10px 0;
}

.profit-positive {
    color: var(--bs-success) !important;
    font-weight: 600;
}

.profit-negative {
    color: var(--bs-danger) !important;
    font-weight: 600;
}

.card-header {
    background: linear-gradient(135deg, #2d2d2d 0%, #3d3d3d 100%);
    border-bottom: 1px solid #444;
}

/* Custom scrollbar for notes */
.trade-notes::-webkit-scrollbar,
.trade-mistakes::-webkit-scrollbar {
    width: 6px;
}

.trade-notes::-webkit-scrollbar-track,
.trade-mistakes::-webkit-scrollbar-track {
    background: #2d2d2d;
    border-radius: 3px;
}

.trade-notes::-webkit-scrollbar-thumb,
.trade-mistakes::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 3px;
}

.trade-notes::-webkit-scrollbar-thumb:hover,
.trade-mistakes::-webkit-scrollbar-thumb:hover {
    background: #777;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .screenshot-image {
        height: 150px;
    }
    
    .btn-group .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
function setModalImage(imageSrc) {
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('downloadImage').href = imageSrc;
}

// Keyboard navigation for trade viewing
document.addEventListener('keydown', function(event) {
    // Only trigger if we're not in an input field
    if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
        if (event.key === 'ArrowLeft' && {{ trade.id > 1 }}) {
            window.location.href = "{{ url_for('trades.view_trade', trade_id=trade.id-1) }}";
        } else if (event.key === 'ArrowRight') {
            window.location.href = "{{ url_for('trades.view_trade', trade_id=trade.id+1) }}";
        } else if (event.key === 'Escape') {
            const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
            if (modal) {
                modal.hide();
            }
        }
    }
});
// Annotation functionality
let annotationCanvas;
let annotationCtx;
let currentTool = 'select';
let isDrawing = false;
let startX, startY;
let currentAnnotation = null;
let annotations = [];
let annotationHistory = [];
let currentHistoryIndex = -1;
let currentImageId = null;

function initImageAnnotation() {
    const images = document.querySelectorAll('.screenshot-image');
    images.forEach(img => {
        img.addEventListener('click', function() {
            const imageId = this.dataset.imageId || 'default';
            openAnnotationTool(this.src, imageId);
        });
    });
}

function openAnnotationTool(imageSrc, imageId) {
    currentImageId = imageId;
    const modal = new bootstrap.Modal(document.getElementById('annotationModal'));
    
    // Initialize canvas
    annotationCanvas = document.getElementById('annotationCanvas');
    annotationCtx = annotationCanvas.getContext('2d');
    
    // Load image onto canvas
    const img = new Image();
    img.onload = function() {
        // Scale canvas to image dimensions while maintaining aspect ratio
        const maxWidth = 1200;
        const maxHeight = 800;
        let { width, height } = calculateAspectRatio(img.width, img.height, maxWidth, maxHeight);
        
        annotationCanvas.width = width;
        annotationCanvas.height = height;
        
        annotationCtx.drawImage(img, 0, 0, width, height);
        
        // Load existing annotations
        loadAnnotations(imageId);
    };
    img.src = imageSrc;
    
    // Set up event listeners
    setupAnnotationTools();
    setupCanvasEvents();
    
    modal.show();
}

function calculateAspectRatio(imgWidth, imgHeight, maxWidth, maxHeight) {
    const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);
    return {
        width: imgWidth * ratio,
        height: imgHeight * ratio
    };
}

function setupAnnotationTools() {
    // Tool selection
    document.querySelectorAll('[data-tool]').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active tool
            document.querySelectorAll('[data-tool]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;
            annotationCanvas.style.cursor = currentTool === 'select' ? 'default' : 'crosshair';
        });
    });

    // Delete buttons
    document.getElementById('deleteSelected').addEventListener('click', deleteSelected);
    document.getElementById('clearAll').addEventListener('click', clearAllAnnotations);

    // Undo/Redo
    document.getElementById('undoBtn').addEventListener('click', undo);
    document.getElementById('redoBtn').addEventListener('click', redo);

    // Save annotation
    document.getElementById('saveAnnotation').addEventListener('click', saveAnnotations);
}

function setupCanvasEvents() {
    annotationCanvas.addEventListener('mousedown', startDrawing);
    annotationCanvas.addEventListener('mousemove', draw);
    annotationCanvas.addEventListener('mouseup', stopDrawing);
    annotationCanvas.addEventListener('mouseout', stopDrawing);
}

function startDrawing(e) {
    if (currentTool === 'select') return;
    
    isDrawing = true;
    const rect = annotationCanvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    
    currentAnnotation = {
        type: currentTool,
        points: [{x: startX, y: startY}],
        color: document.getElementById('drawingColor').value,
        lineWidth: parseInt(document.getElementById('lineWidth').value),
        fontSize: parseInt(document.getElementById('fontSize').value),
        id: Date.now().toString()
    };
    
    if (currentTool === 'text') {
        const text = prompt('Enter text:');
        if (text) {
            currentAnnotation.text = text;
            drawAnnotation(currentAnnotation);
            annotations.push(currentAnnotation);
            saveToHistory();
        }
        isDrawing = false;
        currentAnnotation = null;
    }
}

function draw(e) {
    if (!isDrawing || !currentAnnotation) return;
    
    const rect = annotationCanvas.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    // Update current annotation
    if (currentTool === 'freehand') {
        currentAnnotation.points.push({x: currentX, y: currentY});
    } else {
        currentAnnotation.points[1] = {x: currentX, y: currentY};
    }
    
    // Redraw canvas
    redrawCanvas();
}

function stopDrawing() {
    if (!isDrawing || !currentAnnotation) return;
    
    isDrawing = false;
    
    if (currentAnnotation.points.length > 1 || currentTool === 'freehand') {
        annotations.push(currentAnnotation);
        saveToHistory();
    }
    
    currentAnnotation = null;
}

function redrawCanvas() {
    // Clear canvas
    annotationCtx.clearRect(0, 0, annotationCanvas.width, annotationCanvas.height);
    
    // Redraw image (we need to store the original image)
    const img = new Image();
    img.onload = function() {
        annotationCtx.drawImage(img, 0, 0, annotationCanvas.width, annotationCanvas.height);
        
        // Draw all annotations
        annotations.forEach(annotation => drawAnnotation(annotation));
        
        // Draw current annotation
        if (currentAnnotation) {
            drawAnnotation(currentAnnotation);
        }
    };
    // We need to store the original image source - for simplicity, we'll reload it
    // In production, you might want to store the image data
    img.src = annotationCanvas.toDataURL();
}

function drawAnnotation(annotation) {
    annotationCtx.strokeStyle = annotation.color;
    annotationCtx.fillStyle = annotation.color;
    annotationCtx.lineWidth = annotation.lineWidth;
    annotationCtx.lineCap = 'round';
    annotationCtx.lineJoin = 'round';
    
    switch (annotation.type) {
        case 'line':
        case 'horizontal-line':
        case 'vertical-line':
        case 'ray':
            drawLine(annotation);
            break;
        case 'arrow':
            drawArrow(annotation);
            break;
        case 'rectangle':
            drawRectangle(annotation);
            break;
        case 'circle':
            drawCircle(annotation);
            break;
        case 'triangle':
            drawTriangle(annotation);
            break;
        case 'freehand':
            drawFreehand(annotation);
            break;
        case 'text':
            drawText(annotation);
            break;
        case 'fibonacci-retracement':
            drawFibonacciRetracement(annotation);
            break;
        case 'fibonacci-extension':
            drawFibonacciExtension(annotation);
            break;
    }
}

function drawLine(annotation) {
    const [start, end] = annotation.points;
    annotationCtx.beginPath();
    
    if (annotation.type === 'horizontal-line') {
        annotationCtx.moveTo(0, start.y);
        annotationCtx.lineTo(annotationCanvas.width, start.y);
    } else if (annotation.type === 'vertical-line') {
        annotationCtx.moveTo(start.x, 0);
        annotationCtx.lineTo(start.x, annotationCanvas.height);
    } else if (annotation.type === 'ray') {
        annotationCtx.moveTo(start.x, start.y);
        const dx = end.x - start.x;
        const dy = end.y - start.y;
        const length = Math.sqrt(dx * dx + dy * dy);
        const scale = Math.max(annotationCanvas.width, annotationCanvas.height) / length;
        annotationCtx.lineTo(start.x + dx * scale, start.y + dy * scale);
    } else {
        annotationCtx.moveTo(start.x, start.y);
        annotationCtx.lineTo(end.x, end.y);
    }
    
    annotationCtx.stroke();
}

function drawArrow(annotation) {
    const [start, end] = annotation.points;
    const headLength = 15;
    const angle = Math.atan2(end.y - start.y, end.x - start.x);
    
    // Draw line
    annotationCtx.beginPath();
    annotationCtx.moveTo(start.x, start.y);
    annotationCtx.lineTo(end.x, end.y);
    annotationCtx.stroke();
    
    // Draw arrowhead
    annotationCtx.beginPath();
    annotationCtx.moveTo(end.x, end.y);
    annotationCtx.lineTo(
        end.x - headLength * Math.cos(angle - Math.PI / 6),
        end.y - headLength * Math.sin(angle - Math.PI / 6)
    );
    annotationCtx.lineTo(
        end.x - headLength * Math.cos(angle + Math.PI / 6),
        end.y - headLength * Math.sin(angle + Math.PI / 6)
    );
    annotationCtx.closePath();
    annotationCtx.fill();
}

function drawRectangle(annotation) {
    const [start, end] = annotation.points;
    const width = end.x - start.x;
    const height = end.y - start.y;
    
    annotationCtx.strokeRect(start.x, start.y, width, height);
}

function drawCircle(annotation) {
    const [start, end] = annotation.points;
    const radius = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2));
    
    annotationCtx.beginPath();
    annotationCtx.arc(start.x, start.y, radius, 0, 2 * Math.PI);
    annotationCtx.stroke();
}

function drawTriangle(annotation) {
    const [start, end] = annotation.points;
    
    annotationCtx.beginPath();
    annotationCtx.moveTo(start.x, start.y);
    annotationCtx.lineTo(end.x, end.y);
    annotationCtx.lineTo(start.x - (end.x - start.x), end.y);
    annotationCtx.closePath();
    annotationCtx.stroke();
}

function drawFreehand(annotation) {
    if (annotation.points.length < 2) return;
    
    annotationCtx.beginPath();
    annotationCtx.moveTo(annotation.points[0].x, annotation.points[0].y);
    
    for (let i = 1; i < annotation.points.length; i++) {
        annotationCtx.lineTo(annotation.points[i].x, annotation.points[i].y);
    }
    
    annotationCtx.stroke();
}

function drawText(annotation) {
    const [point] = annotation.points;
    annotationCtx.font = `${annotation.fontSize}px Arial`;
    annotationCtx.fillText(annotation.text, point.x, point.y);
}

function drawFibonacciRetracement(annotation) {
    const [start, end] = annotation.points;
    const levels = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1];
    const priceRange = end.y - start.y;
    
    levels.forEach(level => {
        const y = start.y + priceRange * level;
        annotationCtx.beginPath();
        annotationCtx.moveTo(0, y);
        annotationCtx.lineTo(annotationCanvas.width, y);
        annotationCtx.stroke();
        
        // Draw level label
        annotationCtx.fillText(`${(level * 100).toFixed(1)}%`, 5, y - 5);
    });
}

function drawFibonacciExtension(annotation) {
    const [start, end] = annotation.points;
    const levels = [0, 0.618, 1, 1.618, 2.618];
    const priceRange = end.y - start.y;
    
    levels.forEach(level => {
        const y = start.y + priceRange * level;
        annotationCtx.beginPath();
        annotationCtx.moveTo(0, y);
        annotationCtx.lineTo(annotationCanvas.width, y);
        annotationCtx.strokeStyle = level >= 1 ? '#ff4444' : annotation.color;
        annotationCtx.stroke();
        annotationCtx.strokeStyle = annotation.color;
        
        // Draw level label
        annotationCtx.fillText(`${(level * 100).toFixed(1)}%`, 5, y - 5);
    });
}

function deleteSelected() {
    // For simplicity, delete the last annotation
    // In a full implementation, you'd have selection logic
    if (annotations.length > 0) {
        annotations.pop();
        saveToHistory();
        redrawCanvas();
    }
}

function clearAllAnnotations() {
    if (confirm('Are you sure you want to clear all annotations?')) {
        annotations = [];
        saveToHistory();
        redrawCanvas();
    }
}

function saveToHistory() {
    // Remove any future history if we're not at the end
    annotationHistory = annotationHistory.slice(0, currentHistoryIndex + 1);
    annotationHistory.push(JSON.parse(JSON.stringify(annotations)));
    currentHistoryIndex = annotationHistory.length - 1;
    updateUndoRedoButtons();
}

function undo() {
    if (currentHistoryIndex > 0) {
        currentHistoryIndex--;
        annotations = JSON.parse(JSON.stringify(annotationHistory[currentHistoryIndex]));
        redrawCanvas();
        updateUndoRedoButtons();
    }
}

function redo() {
    if (currentHistoryIndex < annotationHistory.length - 1) {
        currentHistoryIndex++;
        annotations = JSON.parse(JSON.stringify(annotationHistory[currentHistoryIndex]));
        redrawCanvas();
        updateUndoRedoButtons();
    }
}

function updateUndoRedoButtons() {
    document.getElementById('undoBtn').disabled = currentHistoryIndex <= 0;
    document.getElementById('redoBtn').disabled = currentHistoryIndex >= annotationHistory.length - 1;
}

function saveAnnotations() {
    const annotationData = {
        annotations: annotations,
        canvasWidth: annotationCanvas.width,
        canvasHeight: annotationCanvas.height
    };
    
    // Save to localStorage for demo purposes
    // In production, you'd send this to your server
    localStorage.setItem(`annotations_${currentImageId}`, JSON.stringify(annotationData));
    
    // Show success message
    alert('Annotations saved successfully!');
}

function loadAnnotations(imageId) {
    const saved = localStorage.getItem(`annotations_${imageId}`);
    if (saved) {
        const data = JSON.parse(saved);
        annotations = data.annotations || [];
        annotationHistory = [JSON.parse(JSON.stringify(annotations))];
        currentHistoryIndex = 0;
        updateUndoRedoButtons();
        redrawCanvas();
    }
}

// Initialize annotation when page loads
document.addEventListener('DOMContentLoaded', function() {
    initImageAnnotation();
});


// Add loading state for images
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.screenshot-image');
    images.forEach(img => {
        img.addEventListener('load', function() {
            this.style.opacity = '1';
        });
        // Set initial opacity for fade-in effect
        img.style.opacity = '0';
        img.style.transition = 'opacity 0.3s ease-in-out';
    });
});

function initImageAnnotation() {
    const images = document.querySelectorAll('.screenshot-image');
    images.forEach(img => {
        img.addEventListener('click', function() {
            openAnnotationTool(this.src);
        });
    });
}

function openAnnotationTool(imageSrc) {
    // Implement drawing tools for chart analysis
    // Lines, arrows, text, Fibonacci, etc.
    const modal = new bootstrap.Modal(document.getElementById('annotationModal'));
    document.getElementById('annotationImage').src = imageSrc;
    modal.show();
}
</script>
{% endblock %}
